# Data transformation

```{r, message=FALSE, warning=FALSE, echo=FALSE}
library(googlesheets4)
library(readr)
#library(blsAPI)
library(rjson) 
library(dplyr)
library(ggplot2)
library(zoo)
# library(lubridate)
```

## CPI data
The cpi data is accessed through cdc website api via ```googlesheets4::read_sheet```.


```{r, message=FALSE, warning=FALSE, echo=FALSE}
gs4_deauth()
cpi = googlesheets4::read_sheet('1fpEQ4wuuDlnfKokjKyRUrOcIwHUnIBmnBFubCUpnQ94',sheet='chained_data')
cpi1= googlesheets4::read_sheet('1fpEQ4wuuDlnfKokjKyRUrOcIwHUnIBmnBFubCUpnQ94',sheet='Sheet1')
chained = googlesheets4::read_sheet('1fpEQ4wuuDlnfKokjKyRUrOcIwHUnIBmnBFubCUpnQ94',sheet='chained')
```

```{r, message=FALSE, warning=FALSE, echo=FALSE}
head(cpi)
```

We firstly add the item names to our main data of interest by matching corresponding seriesID. Since all attributes are in the string format, it's helpful to convert the item names into the factor type since we are interested in comparing time series for different items and cpi values into numeric values. We also create a new date attribute by concetenating year and month to get the full range of time series, which is further converted into the yearmon type.


```{r, message=FALSE, warning=FALSE, echo=FALSE}
cpi$item_name <- chained$item_name[match(cpi$seriesID, chained$seriesid)]
cpi$item_name = as.factor(cpi$item_name)
cpi$value = as.numeric(cpi$value)
cpi$date <- paste(cpi$year, "-", substr(cpi$period,2,3), sep="")
cpi$date <- as.yearmon(cpi$date, "%Y-%m")
#write.csv(cpi,"data/cpidata.csv", row.names = FALSE)
```

```{r, message=FALSE, warning=FALSE, echo=FALSE}
head(cpi)
```

## Covid data

### United States COVID-19 Cases and Deaths by State overTime

```{r, message=FALSE, warning=FALSE, echo=FALSE}
cdc = read_csv("data/United_States_COVID-19_Cases_and_Deaths_by_State_over_Time.csv")
```


```{r, message=FALSE, warning=FALSE, echo=FALSE}
head(cdc)
```
```{r, message=FALSE, warning=FALSE, echo=FALSE}
cdc[,c('consent_cases')][cdc[,c('consent_cases')] == 'N/A'] = NA
cdc[,c('consent_deaths')][cdc[,c('consent_deaths')] == 'N/A'] = NA
```


```{r, message=FALSE, warning=FALSE, echo=FALSE}
cdc$date = as.Date(cdc$submission_date, '%m/%d/%Y')
cdc$month = as.yearmon(format(as.Date(cdc$date), "%Y-%m"))
```


```{r, message=FALSE, warning=FALSE, echo=FALSE}
cdc.month = cdc %>% mutate(state.mon = paste(state, as.character(month), sep='') ) %>% group_by(state.mon) %>% summarize(new_case = sum(new_case, na.rm = TRUE), new_death = sum(new_death, na.rm = TRUE), month = min(month), state=min(state)) %>% rename(date = month) %>% select(-c(state.mon))
```

```{r, message=FALSE, warning=FALSE, echo=FALSE}
cdc.month$date = as.character(cdc.month$date)
cdc.month$date = paste(substr(cdc.month$date,5,8), match(substr(cdc.month$date,1,3), month.abb), sep="-")
```

```{r merge_city_to_state}
cdc.month$statefull = state.name[match(cdc.month$state,state.abb)]
cdc.month$statefull[cdc.month$state=="DC"] = "Maryland"
cdc.month$statefull[cdc.month$state=="NYC"] = "New York"
```


```{r}
head(cdc.month)
```


```{r}
write.csv(cdc.month,"data/cdcmonth.csv", row.names = FALSE)

```
```{r}
write.csv(cdc,"data/cdc.csv")
```

```{r, message=FALSE, warning=FALSE, echo=FALSE}
cdc.month = read.csv("data/cdcmonth.csv")
cdc.month$date <- as.yearmon(cdc.month$date, "%Y-%m")
```


```{r}
cdc.month
```

### COVID-19 Vaccination and Case Trends by Age Group in United States

```{r, message=FALSE, warning=FALSE, echo=FALSE}
covid.age = read_csv("data/COVID-19_Vaccination_and_Case_Trends_by_Age_Group__United_States.csv")
```



```{r, message=FALSE, warning=FALSE, echo=FALSE}
covid.age$date = as.Date(substr(covid.age$`Date Administered`, 1, 10), '%m/%d/%Y')
```

```{r}
head(covid.age)
```

